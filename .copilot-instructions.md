# GitHub Copilot Instructions for Express.js-Kusto Project

## üìã Project Overview

Express.js-Kusto is a TypeScript framework following folder-based Convention over Configuration paradigm:

- **Multi-Database Support**: Independent Prisma database management per folder in `src/app/db/`
- **Fluent Routing System**: Intuitive API implementation with method chaining-based ExpressRouter
- **Dependency Injection**: Modular architecture through Injectable system
- **Repository Pattern**: Separated data access layer
- **Auto Type Generation**: Automatic TypeScript type generation based on folder structure
- **Full JSON:API v1.1 Compliance**: Standard REST API spec support in CRUD router

## üèóÔ∏è Core Architecture Understanding

### Convention over Configuration
- **Folder Structure = URL Path**: `src/app/routes/users/[userId]/route.ts` ‚Üí `/users/:userId`
- **Folder Name = Keywords**: Injectable, Repository folder names automatically converted to camelCase
- **Minimal Configuration**: Automatic operation by following conventions without complex config files

### Project Structure
```
src/
‚îú‚îÄ‚îÄ core/                    # Framework core (do not modify)
‚îÇ   ‚îú‚îÄ‚îÄ Application.ts       # App entry point
‚îÇ   ‚îú‚îÄ‚îÄ Core.ts             # Internal system
‚îÇ   ‚îî‚îÄ‚îÄ lib/                # Core functionalities
‚îî‚îÄ‚îÄ app/                    # Developer workspace
    ‚îú‚îÄ‚îÄ routes/             # API endpoints (.ts files)
    ‚îú‚îÄ‚îÄ db/                 # Database schemas (per-folder DB)
    ‚îú‚îÄ‚îÄ repos/              # Repository pattern
    ‚îú‚îÄ‚îÄ injectable/         # Dependency injection modules
    ‚îî‚îÄ‚îÄ views/              # HTML templates (.ejs)
```

## üõ£Ô∏è Routing System Guide

### Basic Route File Structure
```typescript
import { ExpressRouter } from '@lib/expressRouter'

const router = new ExpressRouter();

// Use fluent API
router
    .WITH('authRateLimiter', { maxRequests: 5 })
    .WITH('authJwtRequired')
    .GET_VALIDATED(requestConfig, responseConfig, handler)
    .POST_VALIDATED(requestConfig, responseConfig, handler);

export default router.build();
```

### Dynamic Routing (Folder-based)
- `[userId]` ‚Üí `/:userId`
- `[^paramName]` ‚Üí `/:paramName([^/]+)` (regex)
- `..[^paramName]` ‚Üí `/:paramName*` (dynamic path)

### Required Methods and Parameters
All handler functions receive these 5 parameters:
```typescript
async (req, res, injected, repo, db) => {
    // req: Express Request (extended)
    // res: Express Response
    // injected: Dependency injected modules
    // repo: Repository Manager
    // db: Prisma Manager
}
```

### Request Object Extensions
- `req.kusto`: Kusto Manager unified access point (all resources)
- `req.validatedData`: Validated data (only in _VALIDATED methods)

### VALIDATED Methods Important Notes
- **All status codes implementation required**: Must implement all defined response cases
- **Schema compliance required**: Must strictly follow defined request/response formats

## üóÑÔ∏è Database Management

### kusto-db CLI Key Commands
```bash
# Generate clients
kusto-db generate -a

# Migration
kusto-db migrate -t dev -n "migration_name" -d user

# Open studio
kusto-db studio -d user

# Insert seed data
kusto-db seed -d user
```

### Required Prisma Schema Structure
```prisma
generator client {
  provider = "prisma-client-js"
  output   = "client"
}

datasource db {
  provider = "postgresql"
  url      = env("RDS_USER_URL")  # Only environment variable name changeable
}
```

### Environment Variable Naming Convention
- Pattern: `RDS_{DATABASE_NAME}_URL`
- Example: `user` DB ‚Üí `RDS_USER_URL`

## üîå Injectable System

### File Types by Role
1. `*.module.ts`: Business logic service classes (accessed via `injected` parameter)
2. `*.middleware.ts`: Express middleware factories (used in `WITH` method)
3. `*.middleware.interface.ts`: Middleware parameter type definitions

### Usage Example
```typescript
// Use middleware in WITH method
router.WITH('authRateLimiterDefault', {
    repositoryName: 'accountUser',
    maxRequests: 3,
    windowMs: 60000
});

// Access modules in handler
async (req, res, injected, repo, db) => {
    const jwt = injected.authJwtExport;  // Use module
}
```

## üóÇÔ∏è Repository Pattern

### Required Structure
```typescript
import { BaseRepository } from '@lib/baseRepository';

export default class UserRepository extends BaseRepository<'user'> {
    protected getDatabaseName(): 'user' {
        return 'user';
    }
    
    // Method implementations...
}
```

### BaseRepository Key Features
- `this.client`: Type-safe Prisma client
- `this.$transaction()`: Advanced transaction handling
- `this.$batchOperation()`: Batch operation processing

## üîÑ CRUD Router (JSON:API v1.1 Compliant)

### Basic Usage
```typescript
// Basic CRUD generation
router.CRUD('user', 'user');

// UUID-based CRUD
router.CRUD('user', 'user', {
    primaryKey: 'uuid',
    primaryKeyParser: ExpressRouter.parseUuid
});

// Generate specific operations only
router.CRUD('user', 'user', {
    only: ['index', 'show'],
    middleware: {
        index: [authMiddleware],
        show: [authMiddleware]
    }
});
```

### Auto-generated Endpoints
- `GET /` ‚Üí index (filtering, sorting, pagination support)
- `GET /:id` ‚Üí show
- `POST /` ‚Üí create
- `PUT/PATCH /:id` ‚Üí update
- `DELETE /:id` ‚Üí destroy
- `POST /:id/recover` ‚Üí recover

### Advanced Query Support
```bash
# Relationship filtering
GET /posts?filter[author.name_like]=%ÍπÄ%&include=author,tags

# Sorting and pagination
GET /posts?sort=-createdAt&page[number]=2&page[size]=10

# Field selection
GET /posts?select=id,title,author.name
```

## üíª Coding Standards and Rules

### TypeScript Guidelines
- Use strict mode, write JSDoc for all public methods
- Prefer interfaces, follow existing naming conventions

### Security Best Practices
- Use `_VALIDATED` methods for input validation
- Apply appropriate authentication/authorization middleware
- Prevent SQL injection, XSS patterns

### Error Handling
- Use `errorFormatter.ts` for consistent error responses
- Implement proper logging with Winston
- Implement try-catch blocks for async/await patterns

### Performance Considerations
- Implement appropriate caching strategies
- Implement pagination for large datasets
- Utilize BaseRepository batch operations

## üöÄ Development Workflow

### Initial Setup
1. `npm install` - Install dependencies
2. Configure `.env` file (database connection info)
3. `npm run install-cli` - Install kusto-db CLI
4. `kusto-db generate -a` - Generate Prisma clients
5. `kusto-db migrate -t dev -n "initial" -d user` - Deploy schema
6. `npm run dev` - Start development server

### Development Tool URLs
- API Documentation: http://localhost:3000/docs
- Development Dashboard: http://localhost:3000/docs/dev
- Test Reports: http://localhost:3000/docs/test-report

### Auto Type Generation
- Types auto-generated when running `npm run dev` via nodemon
- Immediate type updates when Injectable, Repository files change
- Full auto-completion support in IDE

## ‚ö†Ô∏è Important Notes and Constraints

### File Structure Related
- Only `route.ts`, `middleware.ts` are auto-recognized
- All files must use `export default`
- Must follow dynamic routing folder naming rules

### _VALIDATED Methods
- Must implement responses for all defined status codes
- Must return data that exactly matches response schema
- Missing implementations will cause warnings/errors

### Distributed Transactions
- `$runDistributedTransaction()` usage not recommended
- Reliability issues due to Prisma's connection pool management limitations
- Recommend single DB transactions or application-level compensating transactions

## üîß Updates and Maintenance

### Framework Updates
```bash
npm run updater:check    # Check for new versions
npm run updater:update   # Auto-update (backup required)
```

### Debugging and Development
- `kusto-db debug` - Check system information
- `kusto-db validate -d user` - Schema validation
- Detailed debugging info through Winston logs

---

**When generating code, please follow these guidelines to ensure perfect integration with the existing architecture.**
