name: Auto Release Framework

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  auto-release:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Install GitHub Copilot CLI
      run: |
        # GitHub CLI Copilot í™•ì¥ ì„¤ì¹˜
        gh extension install github/gh-copilot || echo "Copilot extension already installed or failed to install"
        
        # ì„¤ì¹˜ í™•ì¸
        if gh copilot --help >/dev/null 2>&1; then
          echo "âœ… GitHub Copilot CLI successfully installed"
        else
          echo "âŒ GitHub Copilot CLI installation failed"
        fi
    
    - name: Get current version
      id: version_info
      run: |
        # í˜„ì¬ ë²„ì „ ì½ê¸° (ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ)
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        echo "package_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
    
    - name: Generate version tag
      id: version
      run: |
        # í˜„ì¬ ë²„ì „ ì‚¬ìš© (ì¦ê°€ì‹œí‚¤ì§€ ì•ŠìŒ)
        PACKAGE_VERSION="${{ steps.version_info.outputs.package_version }}"
        
        # í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ ë²„ì „ì— ì¶”ê°€
        TIMESTAMP=$(date +"%Y.%m.%d-%H%M")
        
        # íƒœê·¸ ìƒì„± (framework-v{package_version}-{timestamp})
        TAG_NAME="framework-v${PACKAGE_VERSION}-${TIMESTAMP}"
        
        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        echo "Generated tag: ${TAG_NAME}"
    
    - name: Generate update package
      run: |
        echo "Generating framework update package..."
        npm run updater:generate
    
    - name: Find generated package
      id: package
      run: |
        # ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ íŒ¨í‚¤ì§€ íŒŒì¼ ì°¾ê¸°
        PACKAGE_FILE=$(ls -t updater/packages/update-package-*.zip | head -1)
        
        if [ -z "$PACKAGE_FILE" ] || [ ! -f "$PACKAGE_FILE" ]; then
          echo "No package file found!"
          exit 1
        fi
        
        echo "package_file=${PACKAGE_FILE}" >> $GITHUB_OUTPUT
        echo "Found package: ${PACKAGE_FILE}"
        
        # íŒŒì¼ í¬ê¸° í™•ì¸ (Linux í™˜ê²½)
        FILE_SIZE=$(stat -c%s "$PACKAGE_FILE")
        FILE_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $FILE_SIZE/1024/1024}")
        echo "package_size=${FILE_SIZE_MB}MB" >> $GITHUB_OUTPUT
    
    - name: Find generated map file
      id: mapfile
      run: |
        # ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ ë§µ íŒŒì¼ ì°¾ê¸°
        MAP_FILE=$(ls -t updater/map/v*.json | head -1)
        
        if [ -z "$MAP_FILE" ] || [ ! -f "$MAP_FILE" ]; then
          echo "No map file found!"
          exit 1
        fi
        
        echo "map_file=${MAP_FILE}" >> $GITHUB_OUTPUT
        echo "Found map: ${MAP_FILE}"
        
        # ë§µ íŒŒì¼ì—ì„œ íŒŒì¼ ìˆ˜ ê³„ì‚°
        FILE_COUNT=$(jq 'length' "$MAP_FILE")
        echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
    
    - name: Generate release notes with AI
      id: notes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ì´ì „ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ì°¾ê¸°
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep "framework-v" | head -1 || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous release found, using initial commit"
          COMMIT_RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
        else
          echo "Previous release: $PREVIOUS_TAG"
          COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
        fi
        
        # ì»¤ë°‹ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
        COMMITS=$(git log --pretty=format:"- %s (%h)" $COMMIT_RANGE)
        
        # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
        CHANGED_FILES=$(git diff --name-only $COMMIT_RANGE | head -10)
        
        # GitHub Copilotì„ ì‚¬ìš©í•œ AI ìš”ì•½ ìƒì„±
        AI_SUMMARY=""
        if command -v gh copilot >/dev/null 2>&1; then
          echo "ğŸ¤– Generating AI summary with GitHub Copilot..."
          
          # Copilot CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì•½ ìƒì„±
          PROMPT="ë‹¤ìŒ Express.js Kusto í”„ë ˆì„ì›Œí¬ ë³€ê²½ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”: $COMMITS"
          AI_SUMMARY=$(echo "$PROMPT" | gh copilot suggest --type git 2>/dev/null | sed '/^$/d' | head -5 | tr '\n' ' ' || echo "")
          
          if [ -n "$AI_SUMMARY" ]; then
            echo "âœ… AI summary generated successfully"
          else
            echo "âš ï¸ AI summary generation failed, using fallback"
            AI_SUMMARY="GitHub Copilotì„ í†µí•œ ìë™ ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi
        else
          echo "âŒ GitHub Copilot CLI not available"
          AI_SUMMARY="GitHub Copilot CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        {
          echo "# ğŸš€ Express.js Kusto Framework v${{ steps.version.outputs.package_version }}"
          echo ""
          echo "## ğŸ¤– AI Generated Summary"
          echo "${AI_SUMMARY}"
          echo ""
          echo "## ğŸ“¦ Package Information"
          echo "- **Framework Version**: v${{ steps.version.outputs.package_version }}"
          echo "- **Build Timestamp**: ${{ steps.version.outputs.timestamp }}"
          echo "- **Package Size**: ${{ steps.package.outputs.package_size }}"
          echo "- **Files Included**: ${{ steps.mapfile.outputs.file_count }} files"
          echo ""
          echo "## ğŸ“ Recent Changes"
          if [ -n "$COMMITS" ]; then
            echo "$COMMITS"
          else
            echo "ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo ""
          echo "## ğŸ”§ Changed Files (Top 10)"
          echo '```'
          if [ -n "$CHANGED_FILES" ]; then
            echo "$CHANGED_FILES"
          else
            echo "ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          echo '```'
          echo ""
          echo "---"
          echo "**Generated on**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "**Commit**: ${{ github.sha }}"
          echo "**Workflow**: ${{ github.workflow }}"
        } > release_notes.md
        
        echo "âœ… Release notes generated with AI assistance"
    
    - name: Create Release
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHubì˜ ìë™ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ê¸°ëŠ¥ í™œìš©
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep "framework-v" | head -1 || echo "")
        
        # GitHub CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦´ë¦¬ì¦ˆ ìƒì„± (ìë™ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í¬í•¨)
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "Creating release with auto-generated notes from $PREVIOUS_TAG"
          gh release create "${{ steps.version.outputs.tag_name }}" \
            --title "ğŸš€ Framework v${{ steps.version.outputs.package_version }} (${{ steps.version.outputs.timestamp }})" \
            --notes-file release_notes.md \
            --generate-notes \
            --notes-start-tag "$PREVIOUS_TAG" \
            --target main \
            "${{ steps.package.outputs.package_file }}#express-kusto-framework-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.zip" \
            "${{ steps.mapfile.outputs.map_file }}#file-map-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.json"
        else
          echo "Creating first release with custom notes"
          gh release create "${{ steps.version.outputs.tag_name }}" \
            --title "ğŸš€ Framework v${{ steps.version.outputs.package_version }} (${{ steps.version.outputs.timestamp }})" \
            --notes-file release_notes.md \
            --target main \
            "${{ steps.package.outputs.package_file }}#express-kusto-framework-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.zip" \
            "${{ steps.mapfile.outputs.map_file }}#file-map-v${{ steps.version.outputs.package_version }}-${{ steps.version.outputs.timestamp }}.json"
        fi
        
        # ë¦´ë¦¬ì¦ˆ URL ê°€ì ¸ì˜¤ê¸°
        RELEASE_URL=$(gh release view "${{ steps.version.outputs.tag_name }}" --json url --jq .url)
        echo "html_url=${RELEASE_URL}" >> $GITHUB_OUTPUT
    
    - name: Release Summary
      run: |
        echo "ğŸ‰ Release Created Successfully!"
        echo "ğŸ“¦ Release: ${{ steps.create_release.outputs.html_url }}"
        echo "ğŸ·ï¸ Tag: ${{ steps.version.outputs.tag_name }}"
        echo "ğŸ“ Package: ${{ steps.package.outputs.package_file }} (${{ steps.package.outputs.package_size }})"
        echo "ğŸ“‹ Map File: ${{ steps.mapfile.outputs.map_file }} (${{ steps.mapfile.outputs.file_count }} files)"
        echo "ğŸ“Š Version: v${{ steps.version.outputs.package_version }}"
